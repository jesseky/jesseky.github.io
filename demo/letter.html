<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Letter On Picture</title>
    <style type="text/css">
        html,
        body,
        section,
        article,
        section,
        div,
        aside,
        picture,
        input,
        textarea,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            margin: 0;
            padding: 0;
        }

        html,
        body,
        .main,
        .article,
        .aside {
            height: 100%;
        }

        html {
            background: #F2F2F2;
        }

        .main {
            display: flex;
            flex-flow: row nowrap;
            justify-content: center;
            width: 100%;
            overflow: hidden;
        }

        .article {
            flex: 1;
        }

        .aside {
            width: 320px;
            border-left: 1px solid #CCC;
            padding: 0 5px;
        }

        .txt,
        .txa {
            line-height: 24px;
            font-size: 16px;
            display: block;
            box-sizing: border-box;
            -webkit-appearance: none;
            outline: none;
            border: 1px solid #CCC;
            padding: 0 3px;
        }

        .txt {
            width: 30%;
        }

        .txl {
            width: 80%;
        }

        textarea {
            min-height: 240px;
            width: 100%;
            margin: 20px 0;
            height: calc(100vh - 320px);
        }

        .txt:focus,
        .txa:focus {
            color: #20a0ff;
            border-color: #66AFE9;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.075) inset, 0 0 5px rgba(102, 175, 233, 0.6);
            outline: 0px none;
        }

        .file {
            width: 100%;
            margin: 20px 0 0 0;
        }

        .controls {
            display: flex;
            flex-flow: row nowrap;
            justify-content: space-between;
            margin-top: 20px;
        }

        label {
            width: 20%;
        }

        .controls label:not(:first-child) {
            text-align: right;
        }

        h1 {
            font-size: 20px;
            line-height: 2em;
            text-align: center;
            border-bottom: 1px solid #CCC;
        }

        article {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .picture {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 75vh;
            height: 100vh;
            max-width: 98vw;
        }

        .picture canvas {
            background: #FFF;
            background: -webkit-linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), -webkit-linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), rgb(255, 255, 255);
            background: -moz-linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), -moz-linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), rgb(255, 255, 255);
            background: linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), linear-gradient(45deg, rgba(0, 0, 0, 0.0980392) 25%, rgba(0, 0, 0, 0) 25%, rgba(0, 0, 0, 0) 75%, rgba(0, 0, 0, 0.0980392) 75%, rgba(0, 0, 0, 0.0980392) 0), rgb(255, 255, 255);
            background-repeat: repeat, repeat;
            background-position: 0 0, 40px 40px;
            -webkit-background-origin: padding-box, padding-box;
            background-origin: padding-box, padding-box;
            -webkit-background-clip: border-box, border-box;
            background-clip: border-box, border-box;
            -webkit-background-size: 80px 80px, 80px 80px;
            background-size: 80px 80px, 80px 80px;
        }

        .drop-in {
            background: #66AFE9;
        }

        .btn {
            font: inherit;
            width: 100%;
            border-radius: 3px;
            border: 1px solid #B1B1B1;
            box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.05);
            line-height: 1.5em;
            margin: 0;
            padding: 5px 10px;
            background-color: #eee;
            background-image: linear-gradient(#FCFCFC, #EEE);
            -webkit-apparence: none;
        }

        .btn:hover {
            border-color: #CCC;
            background-color: #DDD;
            background-image: linear-gradient(#EEE, #DDD);
        }

        .btn:focus,
        .btn:active {
            outline: 0;
            border-color: #51A7E8;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .btn[disabled],
        .btn[disabled]:hover,
        .btn[disabled]:active {
            color: rgba(102, 102, 102, 0.5);
            background-image: none;
            background-color: #EEE;
            box-shadow: none;
            border: 1px solid #D5D5D5;
            cursor: not-allowed;
        }

        .menu {
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            z-index: 9;
            font-size: 40px;
            line-height: 40px;
            height: 40px;
        }

        .menu-on {
            color: #20a0ff;
        }

        select {
            border: 1px solid #CCC;
            height: 24px;
            border-radius: 0px;
            padding: 0 5px;
        }

        .note {
            position: absolute;
            left: 0;
            top: 0;
            background: #000;
            background: rgba(0, 0, 0, 0.5);
            color: #09f909;
            width: 100%;
            z-index: 2;
            transition: all 0.3s ease-in-out;
        }

        .note-btn {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            display: flex;
            flex-flow: row-reverse;
            align-items: center;
            z-index: 3;
        }

        .note-text {
            padding: 10px;
        }

        .note-hide {
            top: -500px;
        }

        @media screen and (max-width: 1024px) {
            .menu {
                display: block;
            }

            .aside {
                background: rgba(255, 255, 255, 0.8);
                position: absolute;
                right: -100%;
                top: 0;
                width: 90vw;
                max-width: 320px;
                z-index: 5;
                transition: all 0.5s ease-out;
            }

            .aside-hide {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div id="menu" class="menu">☷</div>
    <section id="main" class="main">
        <div class="note-btn"><button id="notebtn">︾</button></div>
        <div id="note" class="note note-hide">
            <div class="note-text">
                <p>说明：</p>
                <p>
                    必须是合法的js数组格式，数组中可以为纯字符、或对象，对象格式如下：
                </p>
                <p>
                    t: 表示文本（text)，<br>
                    c: 表示颜色(color)，<br>
                    s: 表示尺寸(size，为数值，即全局字体大小的倍数)，<br>
                    f: 表示字体 (font)，<br>
                    fs: 表示字体样式（fontStyle，可以是：bold、itlatic、light等值)，<br>
                    st: (值为1时候，使用stroke方式绘制文本，即镂空模式)，<br>
                    换行：<br>
                    l: 表示换行行高(line-height，仅在文本都是\n和空格时候，生效，一个空格默认缩进一个字符)，<br>
                    nc: 表示\n的数量(n-count)，<br>
                    sc: 表示空格的数量(space-count)
                </p>
            </div>
        </div>
        <article class="article">
            <picture class="picture" id="dropIn">
                <canvas id="canvas"></canvas>
            </picture>
        </article>
        <aside class="aside aside-hide" id="aside">
            <div class="block1">
                <h1>选择文件，输入文字</h1>
                <input type="file" id="file" class="file" accept="image/*">
                <div class="controls"><label class="lbl">字体：</label><select id="font" class="txl">
                        <option>sans-serif</option>
                        <option>serif</option>
                        <option>monospace</option>
                    </select></div>
                <div class="controls"><label class="lbl">大小：</label><input class="txt" type="number" id="size" min="10" step="1" value="40"><label class="lbl">水平：</label><input class="txt" type="number" id="offsetx" step="0.1" min="0" value="1"></div>
                <div class="controls"><label class="lbl">颜色：</label><input class="txt" type="text" id="color" value="black"><label class="lbl">垂直：</label><input class="txt" type="text" id="offsety" value="50%"></div>
            </div>
            <textarea class="txa" cols="50" row="10" id="letters"></textarea>
            <button class="btn" id="download">下载</button>
        </aside>
    </section>
</body>
<script type="text/javascript">
    function $id(id) {
        return document.getElementById(id);
    }

    function $q(q) {
        return toDoms(document.querySelectorAll(q));
    }

    function toDoms(o) {
        var ts = Object.prototype.toString.call(o);
        return ts === "[object Array]" ? o : (ts === "[object NodeList]" ? Array.from(o) : [o]);
    }

    function addEvent(obj, evt, callback) {
        if (obj.addEventListener) {
            obj.addEventListener(evt, callback);
        } else if (obj.attachEvent) {
            obj.attachEvent('on' + evt, function (e) {
                e = e || event;
                callback.call(e.target || e.srcElement, e);
            });
        } else {
            obj['on' + evt] = callback;
        }
    }

    function addEvents(els, evt, func) {
        for (var i = 0; i < els.length; i++) addEvent(els[i], evt, func);
    }

    function hasClass(obj, style) {
        return obj.className.split(/\s+/).indexOf(style) > -1;
    }

    function removeClass(obj, style) {
        obj.className = obj.className.split(/\s+/).filter(function (s) {
            return s !== style;
        }).join(' ');
    }

    function toggleClass(obj, style, isAdd) {
        toDoms(obj).forEach(function (el) {
            if (el.classList) {
                if (typeof isAdd !== 'undefined') {
                    el.classList[isAdd ? 'add' : 'remove'](style);
                } else {
                    el.classList.toggle(style);
                }
            } else {
                if (typeof isAdd !== 'undefined') {
                    removeClass(el, style);
                    if (isAdd) {
                        el.className += (el.className ? ' ' : '') + style;
                    }
                } else {
                    if (el.className.includes(style)) {
                        removeClass(el, style);
                    } else {
                        el.className += (el.className ? ' ' : '') + style;
                    }
                }
            }
        });
    }

    function readFile(files, context) {
        if (!files.length || ['image/png', 'image/gif', 'image/jpeg', 'image/jpg'].indexOf(files[0].type) < 0) { // [].includes()
            alert("please select one validate image");
            return;
        }
        var reader = new FileReader();
        reader.onload = function (evt) {
            var image = new Image();
            image.src = evt.target.result;
            image.onload = function () {
                context.image = image;
                preview(context);
            };
        };
        reader.readAsDataURL(files[0]);
    }

    function dropEvent(dropObj, callback) {
        var drop = {
            onThereDo: function (evt) {
                evt.stopPropagation();
                evt.preventDefault();
                if (evt.dataTransfer.types && evt.dataTransfer.types.indexOf("Files") > -1) {
                    toggleClass(dropObj, 'drop-in', true);
                    evt.dataTransfer.dropEffect = 'copy';
                }
            },
            onLevelDo: function (evt) {
                evt.stopPropagation();
                evt.preventDefault();
                removeClass(dropObj, 'drop-in');
            },
            dragenter: function (evt) {
                drop.onThereDo(evt);
            },
            dragover: function (evt) {
                drop.onThereDo(evt);
            },
            dragleave: function (evt) {
                drop.onLevelDo(evt);
            },
            droped: function (evt) {
                drop.onLevelDo(evt);
                if (evt.dataTransfer.files && evt.dataTransfer.files.length) {
                    callback(evt.dataTransfer.files);
                }
            }
        };
        addEvent(dropObj, 'dragenter', function (e) {
            drop.dragenter(e);
        });
        addEvent(dropObj, 'dragleave', function (e) {
            drop.dragleave(e);
        });
        addEvent(dropObj, 'dragover', function (e) {
            drop.dragover(e);
        });
        addEvent(dropObj, 'drop', function (e) {
            drop.droped(e);
        });
    }

    function preview(context) {
        var maxWidth = $id('dropIn').clientWidth;
        var maxHeight = $id('dropIn').clientHeight;
        context.ratio = 1;
        if (context.image) {
            var width = context.image.naturalWidth;
            var height = context.image.naturalHeight;
            var scale = Math.min(maxWidth / width, maxHeight / height);
            context.canvas.width = width * scale;
            context.canvas.height = height * scale;
            context.scale(scale, scale);
            context.ratio = 1 / scale;
            context.clearRect(0, 0, context.canvas.width, context.canvas.height);
            context.drawImage(context.image, 0, 0);
        } else {
            context.canvas.width = maxWidth;
            context.canvas.height = maxHeight;
        }
        drawText(context);
    }

    var fonts = {
        "楷体": "Kaiti",
        "行楷": "Xingkai SC",
        "魏碑": "Weibei SC",
        "雅痞": "Yuppy SC",
        "圆体": "Yuanti SC",
        "黑体": "SimHei",
        "宋体": "Songti SC",
        "仿宋": "FangSong",
        "苹方": "PingFang SC",
        "凌慧体": "LingWai SC",
        "翩翩体": "HanziPen SC",
        "手札体": "Hannotate SC",
        "娃娃体": "Wawati SC",
        "兰亭黑": "Lantinghei SC",
        "思源黑体": "Source Han Sans SC",
        "微软雅黑": "Microsoft YaHei",
        "华文黑体": "STXihei",
        "华文隶书": "STLiti",
        "华文楷体": "STKaiti",
        "华文新魏": "STXinwei",
        "华文琥珀": "STHupo",
        "华文行楷": "STXingkai",
        "华文宋体": "STSong",
        "华文中宋": "STZhongsong",
        "华文仿宋": "STFangsong",
        "冬青黑体": "Hiragino Sans"
    };

    function drawText(context) {
        var color = $id('color').value;
        var offsety = parseFloat($id('offsety').value.replace(/[^\.\d]/, ''));
        var isPercent = $id('offsety').value.indexOf('%') > 0;
        var text = $id('letters').value.trim();
        var font = selectValue($id('font')) || 'monospace';
        var json = {};
        var size = parseInt($id('size').value);
        var ox = size * parseFloat($id('offsetx').value);
        var x = ox;
        var y = context.canvas.height * context.ratio * (!isNaN(offsety) ? (isPercent ? 0.01 : 1) * offsety : 0.5);
        size = size * context.ratio;
        try {
            json = eval(text);
            json.forEach(function (j) {
                if (typeof j === 'string') {
                    j = {
                        t: j
                    };
                }
                if (!j.t) {
                    return;
                }
                if (/^[\s\n]+$/.test(j.t)) {
                    x = ox + Math.max((j.t.match(/[ ]/g) || []).length, j.sc || 0) * size * (j.s || 1);
                    y += Math.max((j.t.match(/\n/g) || []).length, j.nc || 0) * size * (j.l || 1);
                    return;
                }
                var ifont = j.f || font;
                if (fonts[ifont]) {
                    ifont = fonts[ifont];
                }
                ifont = `"${ifont}"`;
                context.font = j.font ? j.font : (j.fs ? j.fs + ' ' : '') + (j.s ? (typeof j.s === 'number' ? j.s * size + 'px' : j.s) + ' ' + ifont : (size + 'px ' + ifont));
                context.textBaseline = j.tbl || '';
                context.textAlign = j.ta || '';
                context.fillStyle = j.c || color;
                context.strokeStyle = j.c || color;
                context[j.st ? "strokeText" : "fillText"](j.t, typeof j.x !== 'undefined' ? x + size * j.x : x, typeof j.y !== 'undefined' ? y + size * j.y : y);
                if (typeof j.x === 'undefined') {
                    x += Array.from(j.t).length * context.font.match(/\d+/)[0];
                }
                if (typeof j.y !== 'undefined') {
                    //y += parseInt(j.y);
                }
            });
        } catch (e) {
            console.log(e);
        }
    }

    function setCaches() {
        $q('.txt,.txa,select').forEach(function (e) {
            localStorage.setItem(e.id, /select/i.test(e.tagName) ? e.selectedIndex : e.value);
        });
    }

    function getCaches() {
        $q('.txt,.txa,select').forEach(function (e) {
            var isSelect = /select/i.test(e.tagName);
            var value = localStorage.getItem(e.id) || (e.value || '');
            e[isSelect ? 'selectedIndex' : 'value'] = isSelect ? parseInt(value) : value;
        });
    }

    function selectValue(s) {
        return s.options[s.selectedIndex].value;
    }

    function loadJs(file, callback) {
        var script = document.createElement('script');
        script.src = file;
        script.onload = callback;
        document.head.appendChild(script);
    }
    window.onload = function () {
        var context = $id('canvas').getContext('2d');
        for (var k in fonts) {
            var option = document.createElement('option');
            option.value = k;
            option.innerHTML = k;
            $id('font').appendChild(option);
        }
        getCaches();
        preview(context);
        addEvent($id('file'), 'change', function (event) {
            readFile(event.target.files, context);
        });
        dropEvent($id('dropIn'), function (files) {
            readFile(files, context);
        });
        addEvent($id('letters'), 'input', function (event) {
            setCaches();
            preview(context);
        });
        addEvents($q('.txt'), 'input', function (event) {
            setCaches();
            preview(context);
        });
        addEvents($q('select'), 'change', function (event) {
            setCaches();
            preview(context);
        });
        addEvent($id('download'), 'click', function (event) {
            event.stopPropagation();
            event.preventDefault();
            if (this.innerHTML !== '') {
                if (!'Blob' in window) {
                    alert("Your browser doesn't support download");
                    return;
                }
                if (!window.saveAs) {
                    loadJs('FileSaver.min.js', function () {
                        $id('canvas').toBlob(function (blob) {
                            saveAs(blob, 'letter.png');
                        });
                    });
                } else {
                    $id('canvas').toBlob(function (blob) {
                        saveAs(blob, 'letter.png');
                    });
                }
            }
        });
        addEvent($id('menu'), 'click', function (event) {
            if ($id('menu').running) {
                return;
            }
            $id('menu').running = true;
            $id('menu').classList.toggle('menu-on');
            var isHide = $id('aside').classList.contains('aside-hide');
            if (isHide) {
                $id('aside').classList.remove('aside-hide');
                setTimeout(function () {
                    $id('aside').style.right = 0;
                    setTimeout(function () {
                        $id('menu').running = false;
                    }, 500);
                }, 0);
            } else {
                $id('aside').style.right = -($id('aside').clientWidth + 100) + 'px';
                setTimeout(function () {
                    $id('aside').classList.add('aside-hide');
                    $id('menu').running = false;
                }, 500);
            }
        });
        addEvent($id('notebtn'), 'click', function (event) {
            $id('note').classList.toggle('note-hide');
        });
        if (!localStorage.getItem('visited')) {
            localStorage.setItem('visited', 'yes');
            $id('note').classList.remove('note-hide');
            setTimeout(function () {
                $id('note').classList.add('note-hide');
            }, 3000);
        }

    };
</script>

</html>